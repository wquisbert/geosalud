<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEO-SALUD | Información al Ciudadano</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 600: '#b91c1c', 700: '#991b1b', 800: '#7f1d1d' }
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'floating': '0 10px 15px -3px rgba(185, 28, 28, 0.15), 0 4px 6px -2px rgba(185, 28, 28, 0.1)'
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        
        #map { height: 100%; min-height: 600px; border-radius: 1rem; z-index: 1; }
        .chart-container { height: 300px; width: 100%; }
        
        /* POPUP PREMIUM MEJORADO */
        .leaflet-popup-content-wrapper { 
            border-radius: 16px; padding: 0; overflow: hidden; border: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .leaflet-popup-content { margin: 0; width: 340px !important; }
        .leaflet-container a.leaflet-popup-close-button {
            color: white; font-size: 18px; top: 8px; right: 8px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .leaflet-container a.leaflet-popup-close-button:hover { color: #fca5a5; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .trans-all { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="antialiased selection:bg-red-100 selection:text-red-900">

    <nav class="bg-white/90 backdrop-blur-lg border-b border-slate-200 sticky top-0 z-50 px-6 py-4 shadow-sm">
        <div class="max-w-[1920px] mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-gradient-to-br from-red-600 to-red-800 text-white w-12 h-12 rounded-xl flex items-center justify-center shadow-lg shadow-red-200">
                    <i class="fa-solid fa-staff-snake text-2xl"></i>
                </div>
                <div>
                    <h1 class="font-extrabold text-xl text-slate-900 tracking-tight leading-none">GEO-SALUD</h1>
                    <p class="text-xs font-semibold text-red-700 uppercase tracking-widest mt-1">Directorio Oficial de Salud</p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                 <div class="text-right hidden md:block">
                    <div class="flex items-center justify-end gap-2 text-[10px] font-bold uppercase tracking-wider text-slate-400">
                        <span class="relative flex h-2.5 w-2.5">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span>
                        </span>
                        Online
                    </div>
                    <p class="text-xs font-bold text-slate-700 mt-0.5" id="last-update">Sincronizando...</p>
                </div>
                <button onclick="openDataModal()" class="group bg-slate-900 hover:bg-brand-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition-all shadow-md hover:shadow-floating flex items-center gap-2">
                    <i class="fa-solid fa-maximize group-hover:scale-110 transition-transform"></i> 
                    <span>Pantalla Completa</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="bg-white border-b border-slate-200 sticky top-[80px] z-40 shadow-sm py-3">
        <div class="max-w-[1920px] mx-auto px-6 flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2 text-slate-500 font-bold text-xs uppercase tracking-wider">
                <i class="fa-solid fa-filter text-red-600"></i> Búsqueda Rápida:
            </div>
            <div class="flex gap-2">
                <div class="relative group">
                    <select id="filter-red" class="appearance-none bg-slate-50 hover:bg-slate-100 border border-slate-200 text-slate-700 py-2 pl-3 pr-8 rounded-lg text-sm focus:ring-2 focus:ring-red-500 outline-none cursor-pointer transition-all w-48 font-medium">
                        <option value="all">Todas las Redes</option>
                    </select>
                    <div class="absolute right-2.5 top-2.5 pointer-events-none text-slate-400 group-hover:text-red-600"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                </div>
                <div class="relative group">
                    <select id="filter-nivel" class="appearance-none bg-slate-50 hover:bg-slate-100 border border-slate-200 text-slate-700 py-2 pl-3 pr-8 rounded-lg text-sm focus:ring-2 focus:ring-red-500 outline-none cursor-pointer transition-all w-48 font-medium">
                        <option value="all">Todos los Niveles</option>
                    </select>
                    <div class="absolute right-2.5 top-2.5 pointer-events-none text-slate-400 group-hover:text-red-600"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                </div>
                <button onclick="resetFilters()" class="px-3 py-2 bg-slate-100 hover:bg-red-50 text-slate-500 hover:text-red-600 border border-slate-200 rounded-lg transition-all" title="Limpiar">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>
        </div>
    </div>

    <main class="max-w-[1920px] mx-auto p-6 space-y-6">
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
            <div class="bg-white p-5 rounded-xl shadow-card border border-slate-100 flex items-center justify-between group hover:border-red-100 transition-colors">
                <div><p class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Total Establecimientos</p><h3 class="text-3xl font-black text-slate-800 mt-1" id="kpi-total">0</h3></div>
                <div class="w-12 h-12 rounded-lg bg-red-50 text-red-600 flex items-center justify-center text-xl"><i class="fa-solid fa-hospital-user"></i></div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-card border border-slate-100 flex items-center justify-between group hover:border-red-100 transition-colors">
                <div><p class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Municipios</p><h3 class="text-3xl font-black text-slate-800 mt-1" id="kpi-muni">0</h3></div>
                <div class="w-12 h-12 rounded-lg bg-slate-50 text-slate-600 flex items-center justify-center text-xl"><i class="fa-solid fa-map-location-dot"></i></div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-card border border-slate-100 flex items-center justify-between group hover:border-red-100 transition-colors">
                <div><p class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Redes de Salud</p><h3 class="text-3xl font-black text-slate-800 mt-1" id="kpi-redes">0</h3></div>
                <div class="w-12 h-12 rounded-lg bg-slate-50 text-slate-600 flex items-center justify-center text-xl"><i class="fa-solid fa-diagram-project"></i></div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-card border border-slate-100 flex items-center justify-between group hover:border-red-100 transition-colors">
                <div class="overflow-hidden"><p class="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Mayor Nivel</p><h3 class="text-xl font-black text-slate-800 mt-2 truncate" id="kpi-top-level">-</h3></div>
                <div class="w-12 h-12 rounded-lg bg-slate-50 text-slate-600 flex items-center justify-center text-xl flex-shrink-0"><i class="fa-solid fa-layer-group"></i></div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            
            <div class="xl:col-span-1 space-y-6">
                <div class="bg-white rounded-xl shadow-card border border-slate-100 p-5">
                    <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2 text-sm uppercase">
                        <i class="fa-solid fa-chart-pie text-red-600"></i> Distribución por Nivel
                    </h4>
                    <div id="container-nivel" class="chart-container"></div>
                </div>
                
                <div class="bg-white rounded-xl shadow-card border border-slate-100 p-5">
                    <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2 text-sm uppercase">
                        <i class="fa-solid fa-chart-simple text-red-600"></i> Por Subsector
                    </h4>
                    <div id="container-subsector" class="chart-container"></div>
                </div>

                <div class="bg-white rounded-xl shadow-card border border-slate-100 overflow-hidden flex flex-col h-[460px]">
                     <div class="px-5 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                        <h4 class="font-bold text-slate-800 text-sm uppercase flex items-center gap-2">
                             <i class="fa-solid fa-list text-red-600"></i> Listado Dinámico
                        </h4>
                        <span id="dashboard-total-badge" class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0 items</span>
                    </div>
                    
                    <div class="overflow-y-auto flex-1 custom-scrollbar">
                        <table class="w-full text-xs text-left">
                            <thead class="text-[10px] text-slate-400 uppercase bg-white sticky top-0 shadow-sm z-10">
                                <tr>
                                    <th class="px-4 py-3 font-bold bg-white">SNIS</th>
                                    <th class="px-4 py-3 font-bold bg-white">Establecimiento</th>
                                    <th class="px-4 py-3 font-bold bg-white text-right">Ficha</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body" class="divide-y divide-slate-50 text-slate-600">
                                </tbody>
                        </table>
                    </div>

                    <div class="px-4 py-3 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
                        <button onclick="changeDashboardPage(-1)" id="dash-prev" class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-500 hover:text-red-600 hover:border-red-200 flex items-center justify-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <span class="text-[10px] font-bold text-slate-500">
                            Pág <span id="dash-current-page">1</span> / <span id="dash-total-pages">1</span>
                        </span>
                        <button onclick="changeDashboardPage(1)" id="dash-next" class="w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-500 hover:text-red-600 hover:border-red-200 flex items-center justify-center transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="xl:col-span-2 relative group h-full min-h-[700px]">
                <div class="bg-white p-1 rounded-xl shadow-card border border-slate-100 h-full">
                    <div id="map" class="h-full w-full rounded-lg"></div>
                </div>

                <div class="absolute bottom-6 left-6 bg-white/95 backdrop-blur border border-slate-200 p-4 rounded-xl shadow-lg z-[400] text-xs transform transition hover:scale-105">
                    <h5 class="font-bold mb-3 text-slate-800 border-b border-slate-100 pb-2 uppercase tracking-wide">
                        Simbología
                    </h5>
                    <div class="space-y-2 font-medium">
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-emerald-500 shadow-sm"></span> <span class="text-slate-600">1er Nivel (Puestos/Centros)</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-amber-500 shadow-sm"></span> <span class="text-slate-600">2do Nivel (Hospitales)</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-rose-600 shadow-sm"></span> <span class="text-slate-600">3er Nivel (Especializado)</span></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="dataModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4 opacity-0 trans-all">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col overflow-hidden transform scale-95 trans-all border border-slate-200">
            <div class="px-8 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-4">
                    <div class="bg-red-50 text-red-600 p-2.5 rounded-lg"><i class="fa-solid fa-server text-xl"></i></div>
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">Directorio General</h2>
                        <p class="text-xs text-slate-500 font-medium">Visualización completa de registros</p>
                    </div>
                </div>
                <button onclick="closeDataModal()" class="w-9 h-9 flex items-center justify-center rounded-full bg-white border border-slate-200 text-slate-400 hover:bg-red-50 hover:text-red-600 hover:border-red-100 transition-all shadow-sm">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="px-8 py-4 bg-white border-b border-slate-100 flex flex-wrap gap-4 justify-between items-center z-10 shadow-sm">
                <div class="relative w-full max-w-md">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                    <input type="text" id="searchInput" placeholder="Buscar..." 
                           class="pl-10 pr-4 py-2.5 w-full bg-slate-50 border border-slate-200 rounded-lg focus:bg-white focus:ring-2 focus:ring-red-100 focus:border-red-400 outline-none transition-all text-sm font-medium text-slate-700">
                </div>
                <div class="text-xs font-bold text-slate-500 bg-slate-50 px-4 py-2 rounded-lg border border-slate-200">
                    <span id="total-records" class="text-slate-800 text-sm">0</span> Total
                </div>
            </div>
            <div class="flex-1 overflow-auto bg-slate-50/30">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-white sticky top-0 shadow-sm font-bold">
                        <tr>
                            <th class="px-6 py-4 bg-white/95 backdrop-blur w-32">Acción</th>
                            <th class="px-6 py-4 bg-white/95 backdrop-blur">SNIS</th>
                            <th class="px-6 py-4 bg-white/95 backdrop-blur">Nombre</th>
                            <th class="px-6 py-4 bg-white/95 backdrop-blur">Municipio</th>
                            <th class="px-6 py-4 bg-white/95 backdrop-blur">Red</th>
                            <th class="px-6 py-4 bg-white/95 backdrop-blur text-center">Nivel</th>
                        </tr>
                    </thead>
                    <tbody id="full-table-body" class="divide-y divide-slate-100 bg-white text-slate-600"></tbody>
                </table>
            </div>
            <div class="px-8 py-4 border-t border-slate-100 bg-white flex justify-between items-center">
                <button id="btn-prev" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:text-red-700 text-xs font-bold uppercase transition-all flex items-center gap-2 shadow-sm"><i class="fa-solid fa-chevron-left"></i> Anterior</button>
                <span class="text-xs font-bold text-slate-500">Pág <span id="current-page">1</span> / <span id="total-pages">1</span></span>
                <button id="btn-next" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 hover:text-red-700 text-xs font-bold uppercase transition-all flex items-center gap-2 shadow-sm">Siguiente <i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>

    <script>
        // CONFIGURACIÓN
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR1DHcWzeJllMtxhIQlpaw6byDlbsji0L4w3SZaWTQDgdz2MdeJEGfB6peldYWgEeQUzgr0hP73zwwt/pub?output=csv'; 

        const COLORS = { level1: '#10b981', level2: '#f59e0b', level3: '#e11d48', default: '#64748b' };

        Highcharts.setOptions({
            chart: { backgroundColor: 'transparent', style: { fontFamily: 'Inter' } },
            title: { display: 'none' },
            xAxis: { gridLineColor: '#f1f5f9', lineColor: '#e2e8f0', labels: { style: { color: '#64748b', fontSize: '10px' } } },
            yAxis: { gridLineColor: '#f1f5f9', title: { text: null }, labels: { style: { color: '#64748b' } } },
            tooltip: { backgroundColor: '#fff', borderColor: '#e2e8f0', borderRadius: 8, style: { color: '#334155' } },
            plotOptions: { pie: { shadow: false, borderWidth: 2, borderColor: '#fff' }, column: { borderRadius: 4, borderwidth: 0 } },
            credits: { enabled: false }
        });

        // ESTADO GLOBAL
        let rawData = [], filteredData = [], mapInstance = null, markersGroup = null;
        let modalData = [], currentPage = 1, rowsPerPage = 12, searchText = "";
        let dashboardPage = 1;
        const dashboardRowsPerPage = 10;

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadData();
            setupEvents();
        });

        function initMap() {
            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' });
            const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri', maxZoom: 18 });
            const modern = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© CARTO', maxZoom: 19 });

            mapInstance = L.map('map', { center: [-16.500, -68.150], zoom: 6, zoomControl: false, layers: [modern] });
            L.control.zoom({ position: 'topright' }).addTo(mapInstance);
            markersGroup = L.layerGroup().addTo(mapInstance);
            L.control.layers({ "Mapa Moderno": modern, "Vista Satelital": satellite, "OpenStreetMap": osm }, { "Establecimientos": markersGroup }, { position: 'topright' }).addTo(mapInstance);
        }

        function loadData() {
            if(SHEET_CSV_URL === 'TU_URL_AQUI') { console.error("Falta URL CSV"); return; }
            Papa.parse(SHEET_CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: (res) => {
                    processData(res.data);
                    document.getElementById('last-update').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) + ' hrs';
                }
            });
        }

        function processData(data) {
            rawData = data.filter(d => {
                if(d.Latitud && d.Longitud && d.NOMBRE) {
                    d.lat = parseFloat(d.Latitud.replace(',', '.'));
                    d.lng = parseFloat(d.Longitud.replace(',', '.'));
                    d.RED = d.RED?.trim() || 'Sin Asignar';
                    d.NIVEL = d.NIVEL?.trim() || 'Sin Nivel';
                    d.PROVINCIA = d.PROVINCIA?.trim() || 'Provincia no especificada';
                    d.SUBSECTOR = d.SUBSECTOR?.trim() || 'Público';
                    d.TIPO = d.TIPO?.trim() || 'Establecimiento de Salud';
                    d.nivelCode = d.NIVEL.match(/\d/) ? d.NIVEL.match(/\d/)[0] : 'default';
                    return !isNaN(d.lat) && !isNaN(d.lng);
                }
                return false;
            });
            filteredData = [...rawData];
            modalData = [...rawData];
            fillSelects();
            updateDashboard();
            renderModalTable();
        }

        function fillSelects() {
            const redes = [...new Set(rawData.map(d => d.RED))].sort();
            const niveles = [...new Set(rawData.map(d => d.NIVEL))].sort();
            const rs = document.getElementById('filter-red'); const ns = document.getElementById('filter-nivel');
            redes.forEach(r => rs.add(new Option(r, r))); niveles.forEach(n => ns.add(new Option(n, n)));
        }

        function setupEvents() {
            const apply = () => {
                const r = document.getElementById('filter-red').value;
                const n = document.getElementById('filter-nivel').value;
                filteredData = rawData.filter(d => (r === 'all' || d.RED === r) && (n === 'all' || d.NIVEL === n));
                dashboardPage = 1; // Resetear página del dashboard al filtrar
                updateDashboard();
            };
            document.getElementById('filter-red').addEventListener('change', apply);
            document.getElementById('filter-nivel').addEventListener('change', apply);

            let timer;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(timer); timer = setTimeout(() => { searchText = e.target.value.toLowerCase(); currentPage = 1; renderModalTable(); }, 300);
            });
            document.getElementById('btn-prev').addEventListener('click', () => { if(currentPage>1) {currentPage--; renderModalTable();} });
            document.getElementById('btn-next').addEventListener('click', () => { if(currentPage < Math.ceil(modalData.length/rowsPerPage)) {currentPage++; renderModalTable();} });
        }

        function resetFilters() {
            document.getElementById('filter-red').value = 'all'; document.getElementById('filter-nivel').value = 'all';
            filteredData = [...rawData]; dashboardPage = 1; updateDashboard();
        }

        function updateDashboard() {
            const d = filteredData;
            document.getElementById('kpi-total').innerText = d.length.toLocaleString();
            document.getElementById('kpi-muni').innerText = new Set(d.map(x=>x.MUNICIPIO)).size;
            document.getElementById('kpi-redes').innerText = new Set(d.map(x=>x.RED)).size;
            const countNivel = {}; d.forEach(x => countNivel[x.NIVEL] = (countNivel[x.NIVEL]||0)+1);
            const top = Object.entries(countNivel).sort((a,b)=>b[1]-a[1])[0];
            document.getElementById('kpi-top-level').innerText = top ? top[0] : '-';

            // Mapa
            markersGroup.clearLayers();
            const bounds = [];
            d.forEach(p => {
                const color = COLORS['level' + p.nivelCode] || COLORS.default;
                const marker = L.circleMarker([p.lat, p.lng], { radius: 6, fillColor: color, color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.9 });
                marker.bindPopup(getPopupHTML(p));
                markersGroup.addLayer(marker);
                bounds.push([p.lat, p.lng]);
            });
            if(bounds.length) mapInstance.fitBounds(bounds, {padding:[50,50]});

            // Gráficos
            const countSub = {}; d.forEach(x => countSub[x.SUBSECTOR] = (countSub[x.SUBSECTOR]||0)+1);
            Highcharts.chart('container-nivel', {
                chart: { type: 'pie', height: 260 },
                plotOptions: { pie: { innerSize: '60%', dataLabels: { enabled: false }, showInLegend: true } },
                series: [{ name: 'Cant', data: Object.entries(countNivel).map(([n,y])=>({name:n, y, color: COLORS['level'+(n.match(/\d/)?.[0])] || '#94a3b8'})) }],
                legend: { align: 'right', layout: 'vertical', verticalAlign: 'middle', itemStyle: {fontSize: '10px'} }
            });
            Highcharts.chart('container-subsector', {
                chart: { type: 'column', height: 260 },
                xAxis: { categories: Object.keys(countSub) },
                series: [{ name: 'Total', data: Object.values(countSub), color: '#b91c1c', showInLegend: false }]
            });

            // Renderizar Tabla del Dashboard
            renderDashboardTable();
        }

        // --- FUNCIÓN GENERADORA DEL POPUP MEJORADO ---
        function getPopupHTML(p) {
            const googleMapLink = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}`;
            let badgeColor = "bg-slate-100 text-slate-700";
            if(p.nivelCode === '1') badgeColor = "bg-emerald-100 text-emerald-800";
            if(p.nivelCode === '2') badgeColor = "bg-amber-100 text-amber-800";
            if(p.nivelCode === '3') badgeColor = "bg-red-100 text-red-800";

            return `
                <div class="font-sans">
                    <div class="bg-gradient-to-r from-red-800 to-red-600 p-4 text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-2 opacity-20"><i class="fa-solid fa-staff-snake text-4xl"></i></div>
                        <h3 class="font-bold text-base leading-tight pr-6 relative z-10">${p.NOMBRE}</h3>
                        <p class="text-xs text-red-100 mt-1 relative z-10 opacity-90 uppercase tracking-wider font-semibold">${p.TIPO}</p>
                    </div>
                    
                    <div class="p-4 space-y-3 bg-white">
                        <div class="flex items-start gap-3">
                            <div class="mt-0.5 text-red-600 w-4 flex justify-center"><i class="fa-solid fa-map-location-dot"></i></div>
                            <div>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Ubicación</p>
                                <p class="text-xs font-bold text-slate-700">${p.PROVINCIA} <span class="text-slate-300 mx-1">/</span> ${p.MUNICIPIO}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 pt-1">
                            <div class="flex items-start gap-2">
                                <div class="mt-0.5 text-slate-400 w-4 flex justify-center"><i class="fa-solid fa-diagram-project text-xs"></i></div>
                                <div>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase">Red Salud</p>
                                    <p class="text-xs font-medium text-slate-700 leading-tight">${p.RED}</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-2">
                                <div class="mt-0.5 text-slate-400 w-4 flex justify-center"><i class="fa-solid fa-building-columns text-xs"></i></div>
                                <div>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase">Subsector</p>
                                    <p class="text-xs font-medium text-slate-700 leading-tight">${p.SUBSECTOR}</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-50 p-2 rounded-lg border border-slate-100 flex justify-between items-center mt-2">
                             <div>
                                <p class="text-[10px] text-slate-400 font-bold uppercase">Cód. SNIS</p>
                                <p class="text-xs font-mono font-bold text-slate-600">${p.COD_SNIS}</p>
                             </div>
                             <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${badgeColor}">${p.NIVEL}</span>
                        </div>

                        <a href="${googleMapLink}" target="_blank" class="block w-full text-center bg-red-600 hover:bg-red-700 text-white font-bold text-xs uppercase py-2.5 rounded-lg shadow-md hover:shadow-lg transition-all mt-3 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-diamond-turn-right"></i> Cómo llegar (Google Maps)
                        </a>
                    </div>
                </div>
            `;
        }

        function renderDashboardTable() {
            const totalDash = filteredData.length;
            const totalDashPages = Math.ceil(totalDash / dashboardRowsPerPage) || 1;
            if(dashboardPage > totalDashPages) dashboardPage = 1;
            const start = (dashboardPage - 1) * dashboardRowsPerPage;
            const pageData = filteredData.slice(start, start + dashboardRowsPerPage);

            document.getElementById('dashboard-total-badge').innerText = `${totalDash} items`;
            document.getElementById('dash-current-page').innerText = dashboardPage;
            document.getElementById('dash-total-pages').innerText = totalDashPages;
            document.getElementById('dash-prev').disabled = dashboardPage === 1;
            document.getElementById('dash-next').disabled = dashboardPage === totalDashPages || totalDash === 0;

            const tbody = document.getElementById('dashboard-table-body');
            tbody.innerHTML = '';
            
            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-red-50 transition-colors border-b border-slate-50";
                tr.innerHTML = `
                    <td class="px-4 py-3 font-mono font-bold text-red-800/70 text-[11px]">${row.COD_SNIS}</td>
                    <td class="px-4 py-3 font-medium text-slate-700 truncate max-w-[150px] text-xs">${row.NOMBRE}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="locate('${row.COD_SNIS}')" class="text-slate-400 hover:text-red-600 transition-colors bg-white border border-slate-200 hover:border-red-300 rounded p-1.5 shadow-sm text-xs"><i class="fa-solid fa-magnifying-glass-location"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function changeDashboardPage(direction) {
            dashboardPage += direction;
            renderDashboardTable();
        }

        function renderModalTable() {
            modalData = searchText ? rawData.filter(d => d.NOMBRE.toLowerCase().includes(searchText) || d.COD_SNIS.includes(searchText)) : [...rawData];
            const total = modalData.length; const pages = Math.ceil(total / rowsPerPage) || 1;
            
            document.getElementById('total-records').innerText = total.toLocaleString();
            document.getElementById('current-page').innerText = currentPage; document.getElementById('total-pages').innerText = pages;
            document.getElementById('btn-prev').disabled = currentPage === 1; document.getElementById('btn-next').disabled = currentPage >= pages;
            
            const tbody = document.getElementById('full-table-body'); tbody.innerHTML = '';
            const start = (currentPage - 1) * rowsPerPage;
            modalData.slice(start, start + rowsPerPage).forEach(row => {
                let colorClass = "bg-slate-100 text-slate-600";
                if(row.nivelCode === '1') colorClass = "bg-emerald-100 text-emerald-700";
                if(row.nivelCode === '2') colorClass = "bg-amber-100 text-amber-700";
                if(row.nivelCode === '3') colorClass = "bg-red-100 text-red-700";
                const tr = document.createElement('tr'); tr.className = "hover:bg-slate-50 border-b border-slate-50 transition-colors";
                tr.innerHTML = `<td class="px-6 py-3"><button onclick="locate('${row.COD_SNIS}')" class="bg-white border border-slate-200 text-red-700 hover:bg-red-600 hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold uppercase transition-all shadow-sm flex items-center gap-2"><i class="fa-solid fa-location-arrow"></i> Ver</button></td><td class="px-6 py-3 font-mono text-xs font-bold text-slate-500">${row.COD_SNIS}</td><td class="px-6 py-3 font-bold text-slate-700 text-xs sm:text-sm">${row.NOMBRE}</td><td class="px-6 py-3 text-xs text-slate-600">${row.MUNICIPIO}</td><td class="px-6 py-3 text-xs text-slate-600">${row.RED}</td><td class="px-6 py-3 text-center"><span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase ${colorClass}">${row.NIVEL}</span></td>`;
                tbody.appendChild(tr);
            });
        }

        function locate(snis) {
            const target = rawData.find(d => d.COD_SNIS == snis);
            if(!target) return;
            closeDataModal();
            mapInstance.flyTo([target.lat, target.lng], 16, { duration: 1.5 });
            setTimeout(() => { L.popup({ offset: [0, -10], className: 'premium-popup' }).setLatLng([target.lat, target.lng]).setContent(getPopupHTML(target)).openOn(mapInstance); }, 1000);
        }

        function openDataModal() { document.getElementById('dataModal').classList.remove('hidden'); setTimeout(() => { document.getElementById('dataModal').classList.remove('opacity-0'); document.querySelector('#dataModal > div').classList.remove('scale-95'); }, 10); }
        function closeDataModal() { document.getElementById('dataModal').classList.add('opacity-0'); document.querySelector('#dataModal > div').classList.add('scale-95'); setTimeout(() => document.getElementById('dataModal').classList.add('hidden'), 300); }
    </script>
</body>
</html>